<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regime-Aware Momentum Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #141b3d;
            --bg-card: #1a2347;
            --text-primary: #e8edf4;
            --text-secondary: #8b95b5;
            --accent-green: #00ff88;
            --accent-red: #ff3366;
            --accent-yellow: #ffd93d;
            --accent-blue: #6c5ce7;
            --border: #2d3561;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: 'Space Mono', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            padding: 1rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 2rem 0;
            border-bottom: 2px solid var(--border);
            margin-bottom: 2rem;
            animation: fadeIn 0.6s ease-out;
        }

        .header h1 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Regime Status */
        .regime-status {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            animation: slideDown 0.6s ease-out 0.2s both;
        }

        .regime-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .regime-mode {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .regime-mode.risk { color: var(--accent-green); }
        .regime-mode.defensive { color: var(--accent-red); }

        .voo-status {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .threshold-table {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .threshold-col {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 8px;
            border-left: 3px solid var(--accent-green);
        }

        .threshold-col.defensive {
            border-left-color: var(--accent-yellow);
        }

        .threshold-col h3 {
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
            color: var(--accent-green);
        }

        .threshold-col.defensive h3 {
            color: var(--accent-yellow);
        }

        .threshold-col ul {
            list-style: none;
            font-size: 0.85rem;
        }

        .threshold-col li {
            padding: 0.25rem 0;
            color: var(--text-secondary);
        }

        /* Controls */
        .controls {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            animation: slideDown 0.6s ease-out 0.4s both;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        input[type="text"], input[type="password"], select {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Space Mono', monospace;
            font-size: 0.9rem;
        }

        input[type="text"]:focus, input[type="password"]:focus, select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        /* Mode Toggle */
        .mode-toggle {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .mode-toggle label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: var(--border);
            border-radius: 15px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: var(--accent-green);
        }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(30px);
        }

        .mode-label {
            font-weight: 700;
            color: var(--accent-green);
        }

        button {
            padding: 0.75rem 2rem;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            border: none;
            border-radius: 8px;
            color: var(--bg-primary);
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 255, 136, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.pause-button {
            background: linear-gradient(135deg, var(--accent-yellow), var(--accent-red));
        }

        /* Countdown Timer */
        .countdown-timer {
            display: none;
            text-align: center;
            padding: 1.5rem;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 12px;
            margin-bottom: 2rem;
        }

        .countdown-timer.active {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        .countdown-display {
            font-family: 'JetBrains Mono', monospace;
            font-size: 3rem;
            font-weight: 700;
            color: var(--accent-green);
            margin-bottom: 0.5rem;
        }

        .countdown-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Progress Container */
        .progress-container {
            display: none;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .progress-container.active {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-green), var(--accent-blue));
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Batch Info */
        .batch-info {
            display: none;
            text-align: center;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: var(--accent-blue);
        }

        .batch-info.active {
            display: block;
        }

        /* Pause Notice */
        .pause-notice {
            display: none;
            background: var(--bg-card);
            border: 2px solid var(--accent-yellow);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        .pause-notice.active {
            display: block;
            animation: pulse 2s ease-in-out infinite;
        }

        .pause-notice h3 {
            color: var(--accent-yellow);
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .pause-notice p {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }

        .pause-notice .countdown-display {
            font-size: 4rem;
            color: var(--accent-yellow);
            margin: 1rem 0;
        }

        /* Auto Mode Status */
        .auto-status {
            display: none;
            padding: 1rem;
            background: var(--bg-secondary);
            border-left: 4px solid var(--accent-green);
            border-radius: 8px;
            margin-top: 1rem;
        }

        .auto-status.active {
            display: block;
        }

        .auto-status p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .auto-status p:last-child {
            margin-bottom: 0;
        }

        /* Results */
        .results {
            animation: fadeIn 0.6s ease-out 0.6s both;
        }

        .result-card {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            animation: slideUp 0.3s ease-out;
        }

        .result-card.deploy {
            border-color: var(--accent-green);
            box-shadow: 0 4px 20px rgba(0, 255, 136, 0.2);
        }

        .result-card.small {
            border-color: var(--accent-yellow);
        }

        .result-card.late {
            border-color: var(--accent-red);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .ticker-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .ticker-name {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-green);
        }

        .asset-badge {
            padding: 0.25rem 0.75rem;
            background: var(--bg-secondary);
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .score-display {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2rem;
            font-weight: 700;
        }

        .score-4 { color: var(--accent-green); }
        .score-3 { color: var(--accent-blue); }
        .score-2 { color: var(--accent-yellow); }
        .score-1 { color: var(--accent-red); }
        .score-0 { color: var(--accent-red); }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .metric {
            background: var(--bg-secondary);
            padding: 0.75rem;
            border-radius: 8px;
            text-align: center;
        }

        .metric-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .metric-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .metric-value.positive { color: var(--accent-green); }
        .metric-value.negative { color: var(--accent-red); }

        .breakdown {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .breakdown-item {
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border-radius: 6px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .breakdown-item.pass {
            border-left: 3px solid var(--accent-green);
        }

        .breakdown-item.fail {
            border-left: 3px solid var(--accent-red);
        }

        .action-box {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 8px;
            font-weight: 700;
            text-align: center;
        }

        .action-box.deploy {
            background: rgba(0, 255, 136, 0.1);
            border: 2px solid var(--accent-green);
            color: var(--accent-green);
        }

        .action-box.small {
            background: rgba(255, 217, 61, 0.1);
            border: 2px solid var(--accent-yellow);
            color: var(--accent-yellow);
        }

        .action-box.late {
            background: rgba(255, 51, 102, 0.1);
            border: 2px solid var(--accent-red);
            color: var(--accent-red);
        }

        .action-box.watch {
            background: rgba(255, 217, 61, 0.1);
            border: 2px solid var(--accent-yellow);
            color: var(--accent-yellow);
        }

        .action-box.avoid {
            background: rgba(255, 51, 102, 0.1);
            border: 2px solid var(--accent-red);
            color: var(--accent-red);
        }

        /* Summary */
        .summary {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            margin-top: 2rem;
        }

        .summary h2 {
            text-align: center;
            margin-bottom: 2rem;
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-blue);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .summary-section {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 8px;
        }

        .summary-section h3 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-size: 1rem;
        }

        .summary-section ul {
            list-style: none;
            font-size: 0.85rem;
        }

        .summary-section li {
            padding: 0.5rem 0;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
        }

        .summary-section li:last-child {
            border-bottom: none;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.8;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }
            
            .threshold-table {
                grid-template-columns: 1fr;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ö° REGIME-AWARE MOMENTUM TRACKER</h1>
            <p>Deploy capital systematically based on technical strength, regime, and momentum</p>
        </div>

        <div class="regime-status">
            <div class="regime-header">
                <div id="regimeMode" class="regime-mode risk">
                    <span id="regimeIcon">üìà</span>
                    <span id="regimeText">RISK MODE</span>
                </div>
                <div id="vooStatus" class="voo-status">VOO: Calculating...</div>
            </div>
            
            <div class="threshold-table">
                <div class="threshold-col">
                    <h3>üü¢ RISK MODE (VOO > 200-DMA)</h3>
                    <ul>
                        <li>‚úì RSI 40-70</li>
                        <li>‚úì Above 20 & 50-DMA</li>
                        <li>‚úì Volume ‚â• 0.8x avg</li>
                        <li>‚úì RS > SPY (3-mo)</li>
                    </ul>
                </div>
                <div class="threshold-col defensive">
                    <h3>üõ°Ô∏è DEFENSIVE MODE (VOO < 200-DMA)</h3>
                    <ul>
                        <li>‚úì RSI 30-70 (wider range)</li>
                        <li>‚úì Above 50-DMA only</li>
                        <li>‚úì Volume ‚â• 1.0x avg (stricter)</li>
                        <li>‚úì RS > SPY (3-mo)</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="input-group">
                <label for="apiKeyInput">Twelve Data API Key:</label>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <input type="password" id="apiKeyInput" placeholder="Enter your API key (saved in browser)" 
                        style="flex: 1;">
                    <button onclick="saveApiKey()" style="padding: 0.75rem 1.5rem; white-space: nowrap;">üíæ Save Key</button>
                    <button onclick="clearApiKey()" style="padding: 0.75rem 1rem; background: linear-gradient(135deg, var(--accent-red), var(--accent-yellow));">üóëÔ∏è</button>
                </div>
                <div id="apiKeyStatus" style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);"></div>
            </div>

            <div class="input-group">
                <label for="tickerInput">Enter Tickers (comma-separated):</label>
                <input type="text" id="tickerInput" placeholder="e.g., AAPL, MSFT, GOOGL, NVDA" 
                    value="AAPL, MSFT, GOOGL, NVDA, TSLA, AMD, META, AMZN">
            </div>

            <div class="input-group">
                <label for="assetTypeInput">Asset Types (optional - ticker:type pairs):</label>
                <input type="text" id="assetTypeInput" placeholder="e.g., GLD:DEFENSIVE, TLT:DEFENSIVE">
            </div>

            <!-- Mode Toggle -->
            <div class="mode-toggle">
                <label>Scan Mode:</label>
                <div id="modeToggle" class="toggle-switch" onclick="toggleMode()">
                    <div class="toggle-slider"></div>
                </div>
                <span id="modeLabel" class="mode-label">MANUAL</span>
            </div>

            <div class="auto-status" id="autoStatus">
                <p><strong>ü§ñ AUTO MODE ENABLED</strong></p>
                <p>‚Ä¢ System will automatically process all batches with 60-second delays</p>
                <p>‚Ä¢ You can pause at any time using the pause button</p>
                <p>‚Ä¢ Each batch processes 4 positions to respect API rate limits</p>
            </div>

            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <button onclick="runAnalysis()" id="runButton">‚ñ∂ RUN ANALYSIS</button>
                <button onclick="pauseAuto()" id="pauseButton" class="pause-button" style="display: none;">‚è∏ PAUSE AUTO</button>
            </div>
        </div>

        <!-- Countdown Timer -->
        <div class="countdown-timer" id="countdownTimer">
            <div class="countdown-display" id="countdownDisplay">120</div>
            <div class="countdown-text">Seconds until next analysis available</div>
        </div>

        <!-- Progress Container -->
        <div class="progress-container" id="progressContainer">
            <div class="batch-info" id="batchInfo">
                <span id="batchProgress">Batch 0 of 0</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Starting analysis...</div>
        </div>

        <!-- Pause Notice -->
        <div class="pause-notice" id="pauseNotice">
            <h3>‚è∏Ô∏è BATCH COMPLETE</h3>
            <p id="pauseText">Batch processing paused. Click Continue to process next batch.</p>
            <div class="countdown-display" id="autoCountdown" style="display: none;">60</div>
            <button onclick="continueAnalysis()" id="continueButton">‚ñ∂ CONTINUE TO NEXT BATCH</button>
        </div>

        <!-- Results -->
        <div class="results" id="results"></div>
    </div>

    <script>
        // API key management
        function getApiKey() {
            return localStorage.getItem('twelveDataApiKey') || '';
        }
        
        function saveApiKey() {
            const apiKeyInput = document.getElementById('apiKeyInput');
            const apiKey = apiKeyInput.value.trim();
            
            if (!apiKey) {
                alert('Please enter an API key');
                return;
            }
            
            localStorage.setItem('twelveDataApiKey', apiKey);
            updateApiKeyStatus();
            alert('API key saved successfully! It will be used for all future scans.');
        }
        
        function clearApiKey() {
            if (confirm('Are you sure you want to remove your saved API key?')) {
                localStorage.removeItem('twelveDataApiKey');
                document.getElementById('apiKeyInput').value = '';
                updateApiKeyStatus();
            }
        }
        
        function updateApiKeyStatus() {
            const apiKey = getApiKey();
            const statusEl = document.getElementById('apiKeyStatus');
            
            if (apiKey) {
                const masked = '‚Ä¢'.repeat(Math.min(apiKey.length, 20));
                statusEl.innerHTML = `‚úÖ API Key saved: <span style="color: var(--accent-green); font-family: monospace;">${masked}</span> <span style="color: var(--text-secondary);">(${apiKey.length} characters)</span>`;
                statusEl.style.color = 'var(--accent-green)';
            } else {
                statusEl.innerHTML = '‚ö†Ô∏è No API key saved. Please enter and save your Twelve Data API key.';
                statusEl.style.color = 'var(--accent-yellow)';
            }
        }
        
        // Load saved API key on page load
        window.addEventListener('DOMContentLoaded', () => {
            const savedKey = getApiKey();
            if (savedKey) {
                document.getElementById('apiKeyInput').value = savedKey;
            }
            updateApiKeyStatus();
        });
        
        const API_DELAY = 8000; // 8 seconds between API calls
        
        let nextAvailableTime = 0;
        let countdownInterval = null;
        let autoMode = false;
        let autoPaused = false;
        let autoCountdownInterval = null;
        
        let batchState = {
            allTickers: [],
            currentBatch: 0,
            batchSize: 4,
            results: [],
            regimeMode: null,
            spyData: null,
            vooData: null,
            isProcessing: false
        };
        
        let assetTypes = {};

        // Toggle between manual and auto mode
        function toggleMode() {
            autoMode = !autoMode;
            const toggle = document.getElementById('modeToggle');
            const label = document.getElementById('modeLabel');
            const autoStatus = document.getElementById('autoStatus');
            
            if (autoMode) {
                toggle.classList.add('active');
                label.textContent = 'AUTO';
                label.style.color = 'var(--accent-green)';
                autoStatus.classList.add('active');
            } else {
                toggle.classList.remove('active');
                label.textContent = 'MANUAL';
                label.style.color = 'var(--text-secondary)';
                autoStatus.classList.remove('active');
            }
        }

        // Pause auto mode
        function pauseAuto() {
            autoPaused = true;
            document.getElementById('pauseButton').style.display = 'none';
            if (autoCountdownInterval) {
                clearInterval(autoCountdownInterval);
                autoCountdownInterval = null;
            }
        }

        // Parse asset types
        function parseAssetTypes() {
            const input = document.getElementById('assetTypeInput').value;
            assetTypes = {};
            
            if (input.trim()) {
                const pairs = input.split(',').map(p => p.trim());
                pairs.forEach(pair => {
                    const [ticker, type] = pair.split(':').map(s => s.trim().toUpperCase());
                    if (ticker && type) {
                        assetTypes[ticker] = type;
                    }
                });
            }
        }

        // Countdown timer
        function startCountdownTimer(seconds) {
            nextAvailableTime = Date.now() + (seconds * 1000);
            const timerEl = document.getElementById('countdownTimer');
            const displayEl = document.getElementById('countdownDisplay');
            
            timerEl.classList.add('active');
            
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            countdownInterval = setInterval(() => {
                const remaining = Math.max(0, Math.ceil((nextAvailableTime - Date.now()) / 1000));
                displayEl.textContent = remaining;
                
                if (remaining === 0) {
                    clearInterval(countdownInterval);
                    timerEl.classList.remove('active');
                }
            }, 1000);
        }

        // Auto countdown between batches
        function startAutoCountdown(seconds, callback) {
            const displayEl = document.getElementById('autoCountdown');
            displayEl.style.display = 'block';
            displayEl.textContent = seconds;
            
            let remaining = seconds;
            
            autoCountdownInterval = setInterval(() => {
                if (autoPaused) {
                    clearInterval(autoCountdownInterval);
                    displayEl.style.display = 'none';
                    return;
                }
                
                remaining--;
                displayEl.textContent = remaining;
                
                if (remaining === 0) {
                    clearInterval(autoCountdownInterval);
                    displayEl.style.display = 'none';
                    callback();
                }
            }, 1000);
        }

        // Update progress
        function updateProgress(current, total, text) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const progressContainer = document.getElementById('progressContainer');
            
            progressContainer.classList.add('active');
            
            const percentage = (current / total) * 100;
            progressFill.style.width = `${percentage}%`;
            progressText.textContent = text;
        }

        // Show pause notice
        function showPauseNotice(currentBatch, totalBatches, remainingTickers) {
            const pauseNotice = document.getElementById('pauseNotice');
            const pauseText = document.getElementById('pauseText');
            const continueButton = document.getElementById('continueButton');
            const autoCountdown = document.getElementById('autoCountdown');
            
            pauseText.textContent = `Batch ${currentBatch} of ${totalBatches} complete. ${remainingTickers} tickers remaining.`;
            pauseNotice.classList.add('active');
            continueButton.disabled = false;
            
            if (autoMode && !autoPaused) {
                // Auto mode: start 60-second countdown
                document.getElementById('pauseButton').style.display = 'block';
                continueButton.style.display = 'none';
                
                startAutoCountdown(60, () => {
                    pauseNotice.classList.remove('active');
                    document.getElementById('pauseButton').style.display = 'none';
                    processBatch();
                });
            } else {
                // Manual mode or paused: wait for user
                continueButton.style.display = 'block';
                autoCountdown.style.display = 'none';
            }
        }

        // Fetch stock data
        async function fetchStockData(ticker) {
            const apiKey = getApiKey();
            
            if (!apiKey) {
                alert('Please save your API key before running analysis');
                throw new Error('No API key available');
            }
            
            try {
                const response = await fetch(
                    `https://api.twelvedata.com/time_series?symbol=${ticker}&interval=1day&outputsize=300&apikey=${apiKey}`
                );
                
                if (!response.ok) {
                    console.error(`Failed to fetch ${ticker}`);
                    return null;
                }
                
                const data = await response.json();
                
                if (data.status === 'error' || !data.values) {
                    console.error(`Error for ${ticker}:`, data.message);
                    return null;
                }
                
                const prices = data.values.map(v => parseFloat(v.close)).reverse();
                const volumes = data.values.map(v => parseFloat(v.volume)).reverse();
                
                return { prices, volumes };
            } catch (error) {
                console.error(`Error fetching ${ticker}:`, error);
                return null;
            }
        }

        // Calculate moving average
        function calculateMA(prices, period) {
            if (prices.length < period) return null;
            const slice = prices.slice(-period);
            return slice.reduce((a, b) => a + b, 0) / period;
        }

        // Calculate RSI
        function calculateRSI(prices, period = 14) {
            if (prices.length < period + 1) return null;
            
            let gains = 0;
            let losses = 0;
            
            for (let i = prices.length - period; i < prices.length; i++) {
                const change = prices[i] - prices[i - 1];
                if (change > 0) gains += change;
                else losses -= change;
            }
            
            const avgGain = gains / period;
            const avgLoss = losses / period;
            
            if (avgLoss === 0) return 100;
            
            const rs = avgGain / avgLoss;
            return 100 - (100 / (1 + rs));
        }

        // Get regime mode
        function getRegimeMode(vooPrices) {
            const currentPrice = vooPrices[vooPrices.length - 1];
            const dma200 = calculateMA(vooPrices, 200);
            return currentPrice > dma200 ? 'RISK' : 'DEFENSIVE';
        }

        // Get active mode for ticker
        function getActiveMode(ticker, regimeMode) {
            const assetType = assetTypes[ticker] || 'RISK';
            
            if (assetType === 'DEFENSIVE') {
                return regimeMode === 'DEFENSIVE' ? 'DEFENSIVE' : 'OFF';
            }
            
            return regimeMode;
        }

        // Calculate score
        function calculateScore(ticker, data, spyData, mode) {
            if (mode === 'OFF') {
                return {
                    score: 0,
                    breakdown: { rsi: false, dma20: false, dma50: false, volume: false, rs: false },
                    perf: { change5d: 0, change1mo: 0 },
                    perfAnalysis: 'Asset type OFF in current regime'
                };
            }
            
            const { prices, volumes } = data;
            const currentPrice = prices[prices.length - 1];
            
            // RSI
            const rsi = calculateRSI(prices);
            const rsiPass = mode === 'RISK' 
                ? (rsi >= 40 && rsi <= 70)
                : (rsi >= 30 && rsi <= 70);
            
            // Moving averages
            const dma20 = calculateMA(prices, 20);
            const dma50 = calculateMA(prices, 50);
            const dma20Pass = currentPrice > dma20;
            const dma50Pass = currentPrice > dma50;
            
            // Volume
            const avgVolume = volumes.slice(-20).reduce((a, b) => a + b, 0) / 20;
            const currentVolume = volumes[volumes.length - 1];
            const volumeThreshold = mode === 'RISK' ? 0.8 : 1.0;
            const volumePass = currentVolume >= (avgVolume * volumeThreshold);
            
            // Relative strength vs SPY
            const spy3moReturn = spyData ? (spyData.prices[spyData.prices.length - 1] / spyData.prices[spyData.prices.length - 63] - 1) : 0;
            const ticker3moReturn = prices[prices.length - 1] / prices[prices.length - 63] - 1;
            const rsPass = ticker3moReturn > spy3moReturn;
            
            // Score calculation
            let score = 0;
            if (rsiPass) score++;
            if (mode === 'RISK' && dma20Pass) score++;
            if (dma50Pass) score++;
            if (volumePass) score++;
            if (rsPass) score++;
            
            // Performance metrics
            const change5d = ((prices[prices.length - 1] / prices[prices.length - 6] - 1) * 100);
            const change1mo = ((prices[prices.length - 1] / prices[prices.length - 21] - 1) * 100);
            
            // Performance analysis
            let perfAnalysis = '';
            if (score >= 3) {
                if (change5d <= 5) perfAnalysis = 'üü¢ DEPLOY NOW (1%)';
                else if (change5d <= 10) perfAnalysis = 'üü° DEPLOY SMALL (0.5-0.75%)';
                else perfAnalysis = 'üî¥ TOO LATE (0.25% or WAIT)';
            } else if (score === 2) {
                perfAnalysis = '‚ö†Ô∏è WATCH (Hold if owned, don\'t enter)';
            } else {
                perfAnalysis = 'üî¥ AVOID/EXIT';
            }
            
            return {
                score,
                breakdown: {
                    rsi: rsiPass,
                    dma20: dma20Pass,
                    dma50: dma50Pass,
                    volume: volumePass,
                    rs: rsPass,
                    rsiValue: rsi,
                    dma20Value: dma20,
                    dma50Value: dma50,
                    volumeRatio: currentVolume / avgVolume
                },
                perf: { change5d, change1mo },
                perfAnalysis
            };
        }

        // Render results
        function renderResults(results, regimeMode) {
            console.log(`üìä renderResults called with ${results.length} results`);
            const resultsDiv = document.getElementById('results');
            
            if (!resultsDiv) {
                console.error('‚ùå Results div not found!');
                return;
            }
            
            console.log(`‚úì Results div found, rendering...`);
            
            // Sort by score descending
            const sorted = [...results].sort((a, b) => b.score - a.score);
            
            // Generate cards
            const cardsHTML = sorted.map(result => {
                const { ticker, assetType, mode, score, breakdown, perf, perfAnalysis } = result;
                
                let cardClass = 'result-card';
                if (perfAnalysis.includes('DEPLOY NOW')) cardClass += ' deploy';
                else if (perfAnalysis.includes('DEPLOY SMALL')) cardClass += ' small';
                else if (perfAnalysis.includes('TOO LATE')) cardClass += ' late';
                
                let actionClass = 'action-box';
                if (perfAnalysis.includes('DEPLOY NOW')) actionClass += ' deploy';
                else if (perfAnalysis.includes('DEPLOY SMALL')) actionClass += ' small';
                else if (perfAnalysis.includes('TOO LATE')) actionClass += ' late';
                else if (perfAnalysis.includes('WATCH')) actionClass += ' watch';
                else actionClass += ' avoid';
                
                return `
                    <div class="${cardClass}">
                        <div class="card-header">
                            <div class="ticker-info">
                                <div class="ticker-name">${ticker}</div>
                                <div class="asset-badge">${assetType}</div>
                                <div class="asset-badge">${mode}</div>
                            </div>
                            <div class="score-display score-${score}">${score}/4</div>
                        </div>
                        
                        <div class="metrics-grid">
                            <div class="metric">
                                <div class="metric-label">5-Day</div>
                                <div class="metric-value ${perf.change5d >= 0 ? 'positive' : 'negative'}">
                                    ${perf.change5d >= 0 ? '+' : ''}${perf.change5d.toFixed(2)}%
                                </div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">1-Month</div>
                                <div class="metric-value ${perf.change1mo >= 0 ? 'positive' : 'negative'}">
                                    ${perf.change1mo >= 0 ? '+' : ''}${perf.change1mo.toFixed(2)}%
                                </div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">RSI (14)</div>
                                <div class="metric-value">${breakdown.rsiValue?.toFixed(1) || 'N/A'}</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Vol Ratio</div>
                                <div class="metric-value">${breakdown.volumeRatio?.toFixed(2) || 'N/A'}x</div>
                            </div>
                        </div>
                        
                        <div class="breakdown">
                            <div class="breakdown-item ${breakdown.rsi ? 'pass' : 'fail'}">
                                ${breakdown.rsi ? '‚úì' : '‚úó'} RSI
                            </div>
                            ${mode === 'RISK' ? `
                                <div class="breakdown-item ${breakdown.dma20 ? 'pass' : 'fail'}">
                                    ${breakdown.dma20 ? '‚úì' : '‚úó'} 20-DMA
                                </div>
                            ` : ''}
                            <div class="breakdown-item ${breakdown.dma50 ? 'pass' : 'fail'}">
                                ${breakdown.dma50 ? '‚úì' : '‚úó'} 50-DMA
                            </div>
                            <div class="breakdown-item ${breakdown.volume ? 'pass' : 'fail'}">
                                ${breakdown.volume ? '‚úì' : '‚úó'} Volume
                            </div>
                            <div class="breakdown-item ${breakdown.rs ? 'pass' : 'fail'}">
                                ${breakdown.rs ? '‚úì' : '‚úó'} RS > SPY
                            </div>
                        </div>
                        
                        <div class="${actionClass}">
                            ${perfAnalysis}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Generate summary
            const deploy = sorted.filter(r => r.perfAnalysis.includes('DEPLOY NOW'));
            const small = sorted.filter(r => r.perfAnalysis.includes('DEPLOY SMALL'));
            const late = sorted.filter(r => r.perfAnalysis.includes('TOO LATE'));
            const watch = sorted.filter(r => r.perfAnalysis.includes('WATCH'));
            const avoid = sorted.filter(r => r.perfAnalysis.includes('AVOID') || r.perfAnalysis.includes('EXIT'));
            
            const summaryHTML = `
                <div class="summary">
                    <h2>üìä DEPLOYMENT SUMMARY</h2>
                    <div class="summary-grid">
                        <div class="summary-section">
                            <h3><span>üü¢</span> DEPLOY NOW (${deploy.length})</h3>
                            <ul>
                                ${deploy.length ? deploy.map(r => `<li>‚Ä¢ ${r.ticker} (${r.mode}) - ${r.score}/4 - Fresh setup</li>`).join('') : '<li>None</li>'}
                            </ul>
                        </div>
                        
                        <div class="summary-section">
                            <h3><span>üü°</span> DEPLOY SMALL (${small.length})</h3>
                            <ul>
                                ${small.length ? small.map(r => `<li>‚Ä¢ ${r.ticker} (${r.mode}) - ${r.score}/4 - Starter size</li>`).join('') : '<li>None</li>'}
                            </ul>
                        </div>
                        
                        <div class="summary-section">
                            <h3><span>üî¥</span> TOO LATE (${late.length})</h3>
                            <ul>
                                ${late.length ? late.map(r => `<li>‚Ä¢ ${r.ticker} (${r.mode}) - Extended move</li>`).join('') : '<li>None</li>'}
                            </ul>
                        </div>
                        
                        <div class="summary-section">
                            <h3><span>‚ö†Ô∏è</span> WATCH (${watch.length})</h3>
                            <ul>
                                ${watch.length ? watch.map(r => `<li>‚Ä¢ ${r.ticker} - Hold if owned, don't enter new</li>`).join('') : '<li>None</li>'}
                            </ul>
                        </div>
                        
                        <div class="summary-section">
                            <h3><span>üî¥</span> AVOID/EXIT (${avoid.length})</h3>
                            <ul>
                                ${avoid.length ? avoid.map(r => `<li>‚Ä¢ ${r.ticker} (${r.mode}) - ${r.score}/4</li>`).join('') : '<li>None</li>'}
                            </ul>
                        </div>
                    </div>
                    
                    <div style="margin-top: 2rem; padding: 1.5rem; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid var(--accent-blue);">
                        <h3 style="color: var(--accent-blue); margin-bottom: 1rem; font-size: 1rem;">üìñ DEPLOYMENT RULES</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; font-size: 0.85rem;">
                            <div>
                                <div style="font-weight: 700; color: var(--accent-green); margin-bottom: 0.5rem;">üü¢ DEPLOY NOW (1%)</div>
                                <div style="color: var(--text-secondary);">Score 3-4 + 5-day change ‚â§5%<br>Fresh setup, good timing</div>
                            </div>
                            <div>
                                <div style="font-weight: 700; color: var(--accent-yellow); margin-bottom: 0.5rem;">üü° DEPLOY SMALL (0.5-0.75%)</div>
                                <div style="color: var(--text-secondary);">Score 3-4 + 5-day change 5-10%<br>Extended but manageable</div>
                            </div>
                            <div>
                                <div style="font-weight: 700; color: var(--accent-red); margin-bottom: 0.5rem;">üî¥ TOO LATE (0.25% max or WAIT)</div>
                                <div style="color: var(--text-secondary);">Score 3-4 + 5-day change >10%<br>Parabolic, high reversal risk</div>
                            </div>
                            <div>
                                <div style="font-weight: 700; color: var(--accent-yellow); margin-bottom: 0.5rem;">‚ö†Ô∏è WATCH (0%)</div>
                                <div style="color: var(--text-secondary);">Score 2 - Don't enter new<br>Hold if already owned</div>
                            </div>
                            <div>
                                <div style="font-weight: 700; color: var(--accent-red); margin-bottom: 0.5rem;">üî¥ EXIT (0%)</div>
                                <div style="color: var(--text-secondary);">Score 0-1 - Trend broken<br>Sell immediately</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            resultsDiv.innerHTML = cardsHTML + summaryHTML;
            console.log(`‚úÖ Results rendered successfully! Check page for ${results.length} position cards.`);
        }

        // Process a single batch
        async function processBatch() {
            if (batchState.currentBatch === 0) {
                // First batch - fetch VOO and SPY
                updateProgress(0, 2, 'Fetching VOO for regime detection...');
                batchState.vooData = await fetchStockData('VOO');
                await new Promise(resolve => setTimeout(resolve, API_DELAY));
                
                batchState.regimeMode = batchState.vooData ? getRegimeMode(batchState.vooData.prices) : 'RISK';
                
                // Update regime display
                const regimeModeEl = document.getElementById('regimeMode');
                const regimeTextEl = document.getElementById('regimeText');
                const regimeIconEl = document.getElementById('regimeIcon');
                const vooStatusEl = document.getElementById('vooStatus');
                
                regimeTextEl.textContent = `${batchState.regimeMode} MODE`;
                regimeModeEl.className = `regime-mode ${batchState.regimeMode.toLowerCase()}`;
                regimeIconEl.textContent = batchState.regimeMode === 'RISK' ? 'üìà' : 'üõ°Ô∏è';
                
                if (batchState.vooData) {
                    const currentPrice = batchState.vooData.prices[batchState.vooData.prices.length - 1];
                    const dma200 = calculateMA(batchState.vooData.prices, 200);
                    const pct = ((currentPrice / dma200 - 1) * 100).toFixed(2);
                    vooStatusEl.textContent = `VOO: $${currentPrice.toFixed(2)} vs 200-DMA: $${dma200.toFixed(2)} (${pct > 0 ? '+' : ''}${pct}%)`;
                }
                
                updateProgress(1, 2, 'Fetching SPY for relative strength...');
                batchState.spyData = await fetchStockData('SPY');
                await new Promise(resolve => setTimeout(resolve, API_DELAY));
            }
            
            // Process current batch of tickers
            const startIdx = batchState.currentBatch * batchState.batchSize;
            const endIdx = Math.min(startIdx + batchState.batchSize, batchState.allTickers.length);
            const batchTickers = batchState.allTickers.slice(startIdx, endIdx);
            
            const totalBatches = Math.ceil(batchState.allTickers.length / batchState.batchSize);
            const batchInfo = document.getElementById('batchInfo');
            const batchProgress = document.getElementById('batchProgress');
            
            batchInfo.classList.add('active');
            batchProgress.textContent = `Batch ${batchState.currentBatch + 1} of ${totalBatches}`;
            
            for (let i = 0; i < batchTickers.length; i++) {
                const ticker = batchTickers[i];
                const overallIdx = startIdx + i;
                
                updateProgress(overallIdx + 1, batchState.allTickers.length, 
                    `Fetching ${ticker} (${overallIdx + 1}/${batchState.allTickers.length})...`);
                
                const data = await fetchStockData(ticker);
                
                if (data) {
                    const assetType = assetTypes[ticker] || 'RISK';
                    const mode = getActiveMode(ticker, batchState.regimeMode);
                    const { score, breakdown, perf, perfAnalysis } = calculateScore(ticker, data, batchState.spyData, mode);
                    
                    batchState.results.push({
                        ticker,
                        assetType,
                        mode,
                        score,
                        breakdown,
                        perf,
                        perfAnalysis
                    });
                    
                    // Render incrementally
                    console.log(`‚úì ${ticker} processed - Score: ${score}/4 - ${perfAnalysis}`);
                    console.log(`Total results so far: ${batchState.results.length}`);
                    renderResults(batchState.results, batchState.regimeMode);
                } else {
                    console.warn(`‚ö† Failed to fetch data for ${ticker}`);
                }
                
                if (i < batchTickers.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, API_DELAY));
                }
            }
            
            batchState.currentBatch++;
            
            // Check if more batches remain
            if (batchState.currentBatch < totalBatches) {
                const remainingTickers = batchState.allTickers.length - (batchState.currentBatch * batchState.batchSize);
                document.getElementById('progressContainer').classList.remove('active');
                showPauseNotice(batchState.currentBatch, totalBatches, remainingTickers);
            } else {
                // All done
                finishAnalysis();
            }
        }

        // Continue to next batch
        async function continueAnalysis() {
            autoPaused = false; // Reset pause flag
            document.getElementById('pauseNotice').classList.remove('active');
            document.getElementById('continueButton').disabled = true;
            await processBatch();
        }

        // Finish analysis
        function finishAnalysis() {
            document.getElementById('progressContainer').classList.remove('active');
            document.getElementById('batchInfo').classList.remove('active');
            document.getElementById('pauseNotice').classList.remove('active');
            document.getElementById('pauseButton').style.display = 'none';
            batchState.isProcessing = false;
            autoPaused = false;
            
            // Start cooldown timer (2 minutes)
            startCountdownTimer(120);
        }

        // Main analysis function
        async function runAnalysis() {
            // Check if still in cooldown
            if (Date.now() < nextAvailableTime) {
                alert('Please wait for the countdown timer to finish before running another analysis.');
                return;
            }
            
            // Parse inputs
            const tickersInput = document.getElementById('tickerInput').value;
            const tickers = tickersInput.split(',').map(t => t.trim().toUpperCase()).filter(t => t);
            
            if (tickers.length === 0) {
                alert('Please enter at least one ticker');
                return;
            }
            
            if (batchState.isProcessing) {
                alert('Analysis already in progress. Please wait or click Continue when ready.');
                return;
            }
            
            parseAssetTypes();
            
            // Reset state
            batchState = {
                allTickers: tickers,
                currentBatch: 0,
                batchSize: 4,
                results: [],
                regimeMode: null,
                spyData: null,
                vooData: null,
                isProcessing: true
            };
            
            autoPaused = false;
            document.getElementById('results').innerHTML = '';
            document.getElementById('pauseNotice').classList.remove('active');
            document.getElementById('pauseButton').style.display = 'none';
            
            try {
                await processBatch();
            } catch (error) {
                console.error('Analysis error:', error);
                alert('Error running analysis. Check console for details.');
                finishAnalysis();
            }
        }
    </script>
</body>
</html>
